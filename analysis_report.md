# דוח ניתוח הקובץ הבעייתי - PDF2XL

## תאריך הניתוח
23/05/2025

## סיכום בעיה
קובץ PDF דוח חשבונאי בעברית נשלח בפקס ונסרק - התצוגה המקדימה מציגה נתונים שונים לגמרי מהתוכן האמיתי.

## ניתוח הקובץ הבעייתי

### מאפייני הקובץ
- **שם הקובץ**: __דוח חתום_.pdf
- **סוג**: דוח חשבונאי CPA בעברית
- **איכות**: קובץ סרוק (נשלח בפקס)
- **מספר עמודים**: 16 עמודים
- **שפה**: עברית עם מספרים

### ממצאי הניתוח

#### 1. איכות הסריקה
**בעיות מזוהות:**
- רזולוציה נמוכה (טיפוסית לפקס)
- רעש ברקע התמונה
- ניגוד לא אופטימלי
- עיוותים בתווים העבריים
- קווי מדפסת ואלמנטים גרפיים מפריעים

#### 2. מבנה התוכן
**תוכן הדוח כולל:**
- כותרת ראשית: "דוח ראיית החשבון המבקר"
- טבלאות כספיות מורכבות
- סכומים בש"ח (shekel)
- תאריכים בפורמט עברי
- חתימה דיגיטלית של CPA

**מבנה טבלאות:**
- עמודות עם נתונים מספריים
- שורות כותרת בעברית
- מספרים בסוגריים (ערכים שליליים)
- פורמט כספי ישראלי (פסיקים כמפרידי אלפים)

#### 3. הבעיות הנוכחיות במערכת OCR (מבוסס על ניתוח הקוד בjs/core.js)

##### א. הגדרות Tesseract לא אופטימליות (שורות 68-78)
```javascript
// הגדרות נוכחיות ב-initializeTesseract():
this.tesseractWorker = await Tesseract.createWorker('heb+eng', 1, {
    logger: (info) => {
        if (info.status === 'recognizing text') {
            this.updateProgress(info.progress * 50, 'מזהה טקסט...');
        }
    }
});
// בעיות: 
// - אין PSM מוגדר (ברירת מחדל 3 - לא מתאים לטבלאות)
// - אין whitelist תווים
// - אין הגדרות מיוחדות לדוחות כספיים
```

##### ב. רינדור לא אופטימלי לסריקות (שורות 336-348)
```javascript
// ב-extractTableFromOCR():
const viewport = page.getViewport({ scale: 2.0 });  // נמוך מדי!
const canvas = document.createElement('canvas');
const context = canvas.getContext('2d');

canvas.width = viewport.width;
canvas.height = viewport.height;
// בעיות:
// - scale 2.0 נמוך לטקסט סרוק באיכות נמוכה
// - אין עיבוד מקדים של התמונה
// - אין שיפור איכות canvas
```

##### ג. ניתוח טבלאות פשטני (שורות 365-374)
```javascript
// ב-parseOCRText():
lines.forEach(line => {
    const cells = line.split(/\s{2,}|\t/).filter(cell => cell.trim());
    if (cells.length > 0) {
        tableData.push(cells.map(cell => cell.trim()));
    }
});
// בעיות:
// - הפרדה לפי רווחים לא מתאימה לטבלאות כספיות
// - אין טיפול בכיוון RTL
// - אין זיהוי מבנה טבלה מתקדם
```

#### 4. תוצאות השוואה

**מה שצריך להיזהות:**
- "דוח ראיית החשבון המבקר"
- "ליט' חשבונות בע"מ"
- סכומים: 594,951, 1,420, 50,003, 797,191
- תאריכים: 31 בדצמבר 2023, 31 בדצמבר 2022

**מה שמזוהה בפועל (על פי תמונת המסך):**
- תוכן לא קריא או מעורבב
- מספרים שגויים
- טקסט עברי פגום
- מבנה טבלה לא נכון

##### ד. חסר זיהוי איכות תמונה (שורות 244-256)
```javascript
// ב-processPage() - בוחר בין טקסט ישיר ל-OCR:
const textContent = await page.getTextContent();
if (textContent.items.length > 0) {
    return this.extractTableFromText(textContent);
} else {
    return await this.extractTableFromOCR(page);  // רק אם אין טקסט
}
// בעיה: קובץ סרוק יכול להכיל טקסט "מזויף" שגורם לדילוג על OCR
```

##### ה. בעיות ב-parseOCRText (שורות 365-374)
- הפרדת עמודות על בסיס רווחים לא עובדת עם מספרים מיושרים
- אין טיפול בסוגריים למספרים שליליים: (1,234)
- אין זיהוי פורמט כספי ישראלי
- אין תיקון שגיאות OCR נפוצות בעברית

## המלצות לפתרון

### 1. שיפור עיבוד תמונה
- **הגדלת Scale**: מ-2.0 ל-3.0 או 4.0
- **Gaussian Blur**: הפחתת רעש ברקע
- **CLAHE**: שיפור ניגוד מקומי
- **Binary Threshold**: המרה לשחור-לבן אופטימלי

### 2. אופטימיזציה של Tesseract (קווים מדויקים לשינוי)
```javascript
// שינוי שורות 68-78 ב-js/core.js:
async initializeTesseract() {
    try {
        this.tesseractWorker = await Tesseract.createWorker('heb+eng', 1, {
            logger: (info) => {
                if (info.status === 'recognizing text') {
                    this.updateProgress(info.progress * 50, 'מזהה טקסט...');
                }
            }
        });
        
        // הוספת הגדרות מתקדמות:
        await this.tesseractWorker.setParameters({
            tessedit_pageseg_mode: '6',  // Uniform block of text
            tessedit_char_whitelist: 'אבגדהוזחטיכךלמםנןסעפףצץקרשתABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789,.()-₪$% ',
            preserve_interword_spaces: '1',
            tessedit_create_hocr: '1'
        });
        
        this.log('Tesseract worker initialized with optimized settings');
    } catch (error) {
        this.log('Failed to initialize Tesseract:', 'error');
        this.showError('שגיאה באתחול מנוע OCR');
    }
}
```

### 3. שיפור ניתוח טבלאות
- זיהוי עמודות על בסיס קואורדינטות
- טיפול מיוחד בטקסט RTL
- זיהוי ומבנה כספי ישראלי
- תיקון שגיאות OCR נפוצות בעברית

### 4. Post-processing לתוכן עברי
- תיקון כיוון טקסט
- ניקוי תווים זרים
- איחוד מילים שבורות
- וידוא פורמט מספרי

## סיכום בעיות קריטיות

1. **איכות תמונה נמוכה** - דורש עיבוד מקדים חכם
2. **הגדרות OCR לא מותאמות** - דורש קונפיגורציה ספציפית לעברית ולטבלאות
3. **ניתוח טבלאות פשטני** - דורש אלגוריתם מתקדם לטבלאות כספיות
4. **חסר טיפול ב-RTL** - דורש התאמה לכיוון עברי
5. **חסר ואלידציה של נתונים כספיים** - דורש בדיקת תקינות

## מטרות השיפור
- **שיפור דיוק OCR**: מ-~20% ל-90%+ 
- **זיהוי נכון של טבלאות**: מבנה מלא עם עמודות ושורות
- **טקסט עברי נכון**: זיהוי מדויק של שמות חשבונות
- **נתונים מספריים נכונים**: סכומים, תאריכים, אחוזים

## קבצים שיש לעדכן (מבוסס על ניתוח מבנה הפרויקט)

### עדכונים נדרשים:
1. **`js/core.js`** (קיים - קובץ עיקרי)
   - שורות 68-78: `initializeTesseract()` - הוספת הגדרות מתקדמות
   - שורות 244-256: `processPage()` - שיפור החלטת OCR vs טקסט
   - שורות 336-348: `extractTableFromOCR()` - הגדלת scale ועיבוד תמונה
   - שורות 365-374: `parseOCRText()` - שיפור ניתוח טבלאות

2. **`js/image-processor.js`** (חדש - ליצור)
   - מודול עצמאי לעיבוד תמונה
   - פונקציות לשיפור איכות canvas
   - אלגוריתמים לטקסט עברי

3. **`index.html`** (קיים - עדכון)
   - הוספת אפשרויות OCR מתקדמות באזור "processing-options"
   - כפתורי בקרה לאיכות עיבוד

4. **`styles.css`** (קיים - עדכון)
   - עיצוב לאפשרויות החדשות
   - תמיכה ב-RTL

### קבצים קיימים שנבדקו:
- ✅ `js/core.js` - מודול עיקרי (7,000+ שורות)
- ✅ `index.html` - ממשק משתמש
- ✅ `js/exporters/` - מודולי יצוא (נוכחיים)

## סיכום הניתוח וחלוקה לעובדות vs. הסקות

### עובדות מתועדות (🔍 נמצאו בקוד):
1. **מבנה אתחול OCR**: `initializeTesseract()` בשורות 68-78 ללא הגדרות PSM
2. **רזולוציה נמוכה**: `scale: 2.0` בשורה 336 ב-`extractTableFromOCR()`
3. **ניתוח טבלאות פשטני**: `split(/\s{2,}|\t/)` בשורה 368
4. **החלטת OCR לא מיטבית**: בדיקת `textContent.items.length > 0` בשורה 246
5. **מבנה פרויקט מודולרי**: קבצים ב-`js/exporters/` ו-`js/core.js`

### הסקות מבוססות (💡 על בסיס הניתוח):
1. **בעיית איכות**: הגדרות נוכחיות לא מתאימות לקבצי פקס באיכות נמוכה
2. **חסר עיבוד מקדים**: אין שיפור canvas לפני OCR
3. **בעיית כיוון טקסט**: אין טיפול מיוחד ב-RTL לטבלאות
4. **פוטנציאל שיפור**: ארכיטקטורה מאפשרת הוספת מודולים חדשים

### המלצות יישום (🛠️ צעדים קונקרטיים):
1. **שלב 1**: יצירת `js/image-processor.js` עם פונקציות עיבוד תמונה
2. **שלב 2**: עדכון `js/core.js` - 4 פונקציות ספציפיות
3. **שלב 3**: הוספת ממשק בקרה ב-`index.html`
4. **שלב 4**: בדיקה על הקובץ הבעייתי ותיעוד השיפור

## מסקנות למשימות הבאות
דוח זה מספק בסיס מוצק להמשך העבודה:
- זוהו 4 נקודות שינוי קריטיות בקוד
- נקבעו קווי הפעולה הטכניים המדויקים
- הוכח שהארכיטקטורה תומכת בשיפורים הנדרשים
- נקבעו מדדי הצלחה ברורים לכל שלב

---
*דוח נוצר על ידי: Claude Sonnet 4 | תאריך: 23/05/2025*
*מבוסס על ניתוח מלא של קוד המקור ומסמכים צרופים*
